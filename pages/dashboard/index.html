<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon.ico">
    <!-- stylesheet -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Kanit">
    <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="../../plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
    <link rel="stylesheet" href="../../plugins/bootstrap-toggle/bootstrap-toggle.min.css">
    <link rel="stylesheet" href="../../plugins/toastr/toastr.min.css">
    <link rel="stylesheet" href="../../assets/css/adminlte.min.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- Datatables -->
    <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">

    <style>
        .form-label {
            font-size: 16px;
            font-family: 'Kanit', sans-serif;
            font-weight: bold;
        }

        .swal-lable,
        .custom-file-label {
            display: block;
            text-align: start;
        }

        .swal-style {
            background-color: white;
            height: 400px;
            border-radius: 20px;
        }

        .title-style {
            font-size: 30px;
        }

        /* Table styles */
        #matchDataTable {
            border-radius: 10px;
            overflow: hidden;  /* This ensures the border-radius is visible */
        }

        #matchDataTable thead th {
            background-color: #dc3545;
            color: white;
        }

        /* Optional: Add some spacing around the table */
        .card-body.table-responsive {
            padding: 15px;
        }
    </style>

</head>

<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <div id="sidebar"></div>
        <div class="content-wrapper pt-3">
            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow">
                                <div class="card-header shadow">
                                    <h2 class="mb-3">
                                        <i class="fa-solid fa-user-tie"></i>
                                        กรอกข้อมูลนักกีฬา
                                    </h2>
                                    <div class="mb-3 d-flex align-items-center">
                                        <div class="dropdown mr-2">
                                            <button class="btn btn-success btn-sm dropdown-toggle" type="button"
                                                id="dropdownMatchType" data-toggle="dropdown" aria-expanded="false">
                                                เลือกประเภทมวย
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="dropdownMatchType">
                                                <a class="dropdown-item" href="#" data-value="มวยสากล">มวยสากล</a>
                                                <a class="dropdown-item" href="#" data-value="มวยสาธิต">มวยสาธิต</a>
                                            </div>
                                            <input type="hidden" id="Match_Type" name="Match_Type" required>
                                        </div>
                                        <button class="btn btn-warning btn-sm" id="clearDataButton"
                                            onclick="clearAllData()">
                                            <i class="fa-solid fa-trash-can"></i> ลบข้อมูลทั้งหมด
                                        </button>
                                    </div>

                                    <div class="p-2" id="form_demonstration_boxing">
                                        <div class="card-body">

                                            <form id="addDataForm-Match" enctype="multipart/form-data">
                                                <!-- Match Name -->
                                                <div class="mb-3">
                                                    <label for="data_match" class="form-label">ชื่อแมตช์ <span
                                                            class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <input type="text" 
                                                            data-id="" 
                                                            class="form-control"
                                                            id="data_match" 
                                                            name="data_match"
                                                            placeholder="กรอกชื่อแมตช์" 
                                                            aria-label="Match Name"
                                                            required>
                                                        <div class="input-group-append">
                                                            <button type="button" class="btn btn-warning"
                                                                id="editMatchNameButton">แก้ไข</button>
                                                            <button type="button" class="btn btn-primary"
                                                                id="updateMatchNameButton">อัพเดท</button>
                                                            <button type="button" class="btn btn-success"
                                                                id="lockMatchNameButton">บันทึก</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>

                                            <form id="addDataForm" enctype="multipart/form-data">

                                                <div class="row">
                                                    <!-- Red -->
                                                    <div class="col-lg-6">
                                                        <div class="mb-3">
                                                            <label for="person_red" class="form-label">ชื่อมุมสีแดง
                                                                <span class="text-danger">*</span></label>
                                                            <input type="text" class="form-control" id="person_red"
                                                                name="person_red" placeholder="กรอกชื่อฝ่ายแดง"
                                                                required />
                                                        </div>

                                                        <div class="mb-3">
                                                            <label for="inputImageRed"
                                                                class="form-label">เลือกรูปมุมสีแดง</label>
                                                            <div class="custom-file">
                                                                <input type="file" class="custom-file-input"
                                                                    id="inputImageRed" name="image_red">
                                                                <label class="custom-file-label" id="labelImageRed"
                                                                    for="inputImageRed">เลือกไฟล์</label>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Blue -->
                                                    <div class="col-lg-6">
                                                        <div class="mb-3">
                                                            <label for="person_blue" class="form-label">ชื่อมุมสีน้ำเงิน
                                                                <span class="text-danger">*</span></label>
                                                            <input type="text" class="form-control" id="person_blue"
                                                                name="person_blue" placeholder="กรอกชื่อฝ่ายน้ำเงิน"
                                                                required />
                                                        </div>

                                                        <div class="mb-3">
                                                            <label for="inputImageBlue"
                                                                class="form-label">เลือกรูปมุมสีน้ำเงิน</label>
                                                            <div class="custom-file">
                                                                <input type="file" class="custom-file-input"
                                                                    id="inputImageBlue" name="image_blue">
                                                                <label class="custom-file-label" id="labelImageBlue"
                                                                    for="inputImageBlue">เลือกไฟล์</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="text-center mb-3" style="font-size: 18px;">
                                                    <button type="button" onclick="addData()" class="btn btn-primary"
                                                        style="width: 400px;">บันทึก</button>
                                                </div>

                                            </form>
                                        </div>

                                        <div class="card-body table-responsive mt-4">
                                            <table id="matchDataTable" class="table table-bordered table-striped">
                                                <thead>
                                                    <tr>
                                                        <th width="5%">ลำดับ</th>
                                                        <th width="20%">ชื่อฝ่ายแดง</th>
                                                        <th width="20%">ชื่อฝ่ายน้ำเงิน</th>
                                                        <th width="20%">รูปฝ่ายแดง</th>
                                                        <th width="20%">รูปฝ่ายน้ำเงิน</th>
                                                        <th width="5%">สถานะ</th>
                                                        <th width="10%">จัดการ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer"></div>
    </div>


    <!-- scripts -->
    <script src="../../plugins/fontawesome-free/js/all.min.js"></script>
    <script src="../../plugins/jquery/jquery.min.js"></script>
    <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../../plugins/sweetalert2/sweetalert2.min.js"></script>
    <script src="../../plugins/bootstrap-toggle/bootstrap-toggle.min.js"></script>
    <script src="../../plugins/toastr/toastr.min.js"></script>
    <script src="../../assets/js/adminlte.min.js"></script>

    <!-- datatables -->
    <script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>

    <script>
        // โหลด Sidebar
        fetch('../includes/sidebar.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('sidebar').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading sidebar:', error);
            });

        // โหลด Footer
        fetch('../includes/footer.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('footer').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading footer:', error);
            });

        // จัดการฟังก์ชันัันทึกข้อมูล
        function getLastSportPersonId() {
            return $.ajax({
                url: '../../service/match/get_last_sport_person_id.php',
                type: 'GET',
                dataType: 'json'
            });
        }

        function addData() {
            // ปรวจสอบข้อมูลที่จำเป็น
            const matchName = $('#data_match').val().trim();
            const personRed = $('#person_red').val().trim();
            const personBlue = $('#person_blue').val().trim();
            const matchType = $('#Match_Type').val();

            // สร้าง array เก็บข้อความ error
            let errors = [];

            if (!matchName) {
                errors.push('กรุณากรอกชื่อแมตช์');
            }
            if (!personRed) {
                errors.push('กรุณากรอกชื่อนักมวยฝ่ายแดง');
            }
            if (!personBlue) {
                errors.push('กรุณากรอกชื่อนักมวยฝ่ายน้ำเงิน');
            }
            if (!matchType) {
                errors.push('กรุณาเลือกประเภทมวย');
            }

            // ถ้ามี error แสดงข้อความแจ้งเตือน
            if (errors.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณากรอกข้อมูลให้ครบถ้วน',
                    html: errors.join('<br>'),
                    confirmButtonText: 'ตกลง'
                });
                return false;
            }

            // ป้องกันการ submit ซ้ำ
            $('#addDataForm button[type="button"]').prop('disabled', true);

            // ตึงเลขลำดับล่าสุดก่อนบันทึก
            getLastSportPersonId().then(function(response) {
                const newNumber = response.last_number + 1;

                // สร้าง FormData object
                const formData = new FormData();
                
                // เพิ่มข้อมูลเข้า FormData
                formData.append('data_match', matchName);
                formData.append('Match_Type', matchType);
                formData.append('person_red', personRed);
                formData.append('person_blue', personBlue);
                formData.append('sport_person_id', newNumber);

                // เพิ่มไฟล์รูปภาพ (ถ้ามี)
                const imageRed = $('#inputImageRed')[0].files[0];
                const imageBlue = $('#inputImageBlue')[0].files[0];
                
                if (imageRed) {
                    formData.append('image_red', imageRed);
                }
                if (imageBlue) {
                    formData.append('image_blue', imageBlue);
                }

                // ส่งข้อมูลไปยัง PHP
                $.ajax({
                    url: '../../service/match/save_match.php',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    dataType: 'json',
                    success: function(response) {
                        $('#addDataForm button[type="button"]').prop('disabled', false);
                        
                        // ไม่ต้อง parse JSON อีกเพราะ jQuery จะทำให้อัตโนมัติ
                        if (response.status === 'success') {
                            Swal.fire({
                                icon: 'success',
                                title: 'บันทึกสำเร็จ',
                                text: 'ข้อมูลของคุณถูกบันทึกเรียบร้อยแล้ว',
                                confirmButtonText: 'ตกลง'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // ล้างฟอร์มและรีเฟรชตาราง
                                    $('#person_red').val('');
                                    $('#person_blue').val('');
                                    $('.custom-file-label').html('เลือกไฟล์');
                                    $('#inputImageRed').val('');
                                    $('#inputImageBlue').val('');
                                    refreshTable();
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: response.message || 'ไม่สามารถบันทึกข้อมูลได้',
                                confirmButtonText: 'ตกลง'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#addDataForm button[type="button"]').prop('disabled', false);
                        console.error('AJAX Error:', error);
                        console.error('Server Response:', xhr.responseText);
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์',
                            confirmButtonText: 'ตกลง'
                        });
                    }
                });
            }).catch(function(error) {
                console.error('Error getting last ID:', error);
                $('#addDataForm button[type="button"]').prop('disabled', false);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถดึงรหัสล่าสุดได้',
                    confirmButtonText: 'ตกลง'
                });
            });

            return false;
        }
        // แสดงชื่อไฟล์ที่เลือก
        $('.custom-file-input').on('change', function() {
            const fileName = $(this).val().split('\\').pop();
            $(this).next('.custom-file-label').html(fileName);
        });

        // ฟังก์ชันล้างข้อมูลทั้งหมด
        function clearAllData() {
            Swal.fire({
                title: 'ยืนยันการลบข้อมูล',
                text: "คุณต้องการลบข้อมูลทั้งหมดใช่หรือไม่?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ใช่, ลบทั้งหมด',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // แสดง loading
                    Swal.fire({
                        title: 'กำลังดำเนินการ...',
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false
                    });

                    // ส่ง request แบบ POST
                    $.ajax({
                        url: '../../service/match/delete_all_matches.php',
                        method: 'POST',
                        dataType: 'json',
                        success: function(response) {
                            if (response.status === 'success') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'สำเร็จ!',
                                    text: response.message
                                }).then(() => {
                                    location.reload(); // รีเฟรชหน้าเว็บ
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาด!',
                                    text: response.message
                                });
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด!',
                                text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้'
                            });
                        }
                    });
                }
            });
        }

        $(document).ready(function() {
            // เพิ่ม event handler สำหรับ dropdown ประเภทมวย
            $('.dropdown-menu .dropdown-item').click(function(e) {
                e.preventDefault();
                const selectedValue = $(this).data('value');
                const dropdownButton = $('#dropdownMatchType');
                
                // อัพเดทข้อความบนปุ่ม
                dropdownButton.text(selectedValue);
                
                // เก็บค่าที่เลือกใน hidden input
                $('#Match_Type').val(selectedValue);
                
                // เพิ่ม visual feedback
                $('.dropdown-item').removeClass('active');
                $(this).addClass('active');
            });

            // Initialize DataTable
            var table = $('#matchDataTable').DataTable({
                "processing": true,
                "serverSide": false,
                "ajax": {
                    "url": "../../service/match/get_match_data.php",
                    "type": "POST",
                    "dataSrc": function(json) {
                        if (!json.data) {
                            return [];
                        }
                        return json.data;
                    }
                },
                "columns": [
                    { 
                        "data": null,
                        "render": function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { "data": "person_red" },
                    { "data": "person_blue" },
                    { 
                        "data": "image_red",
                        "render": function(data, type, row) {
                            if (data) {
                                return '<img src="../../' + data + '" class="img-thumbnail" width="100">';
                            }
                            return 'ไม่มีรูป';
                        }
                    },
                    { 
                        "data": "image_blue",
                        "render": function(data, type, row) {
                            if (data) {
                                return '<img src="../../' + data + '" class="img-thumbnail" width="100">';
                            }
                            return 'ไม่มีรูป';
                        }
                    },
                    {
                        "data": "isActive",
                        "render": function(data, type, row) {
                            const isActive = (data === '1' || data === 1 || data === true);
                            return `<div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input status-toggle" 
                                    id="statusSwitch${row.id}" 
                                    ${isActive ? 'checked' : ''} 
                                    data-id="${row.id}">
                                <label class="custom-control-label" for="statusSwitch${row.id}"></label>
                            </div>`;
                        }
                    },
                    {
                        "data": null,
                        "render": function(data, type, row) {
                            return `
                                <button class="btn btn-warning btn-sm edit-btn" data-id="${row.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${row.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                    }
                ],
                "language": {
                    "lengthMenu": "แสดง _MENU_ รายการ",
                    "zeroRecords": "ไม่พบข้อมูล",
                    "info": "แสดงหน้า _PAGE_ จาก _PAGES_",
                    "infoEmpty": "ไม่มีข้อมูล",
                    "infoFiltered": "(กรองจากทั้งหมด _MAX_ รายการ)",
                    "search": "ค้นหา:",
                    "paginate": {
                        "first": "หน้าแรก",
                        "last": "หน้าสุขท้าย",
                        "next": "ถัดไป",
                        "previous": "ก่อนหน้า"
                    },
                    "loadingRecords": "กำลังโหลด...",
                    "processing": "กำลังประมวลผล..."
                },
                "order": [[0, 'asc']],
                "pageLength": 10,
                "searching": true,
                "ordering": true,
                "responsive": true
            });

            // Refresh function
            window.refreshTable = function() {
                table.ajax.reload(null, false);
            };

            // Handle Edit Button Click
            $('#matchDataTable').on('click', '.edit-btn', function() {
                var id = $(this).data('id');
                var row = $(this).closest('tr');
                var person_red = row.find('td:eq(1)').text();
                var person_blue = row.find('td:eq(2)').text();
                var image_red = row.find('td:eq(3) img').attr('src') || '';
                var image_blue = row.find('td:eq(4) img').attr('src') || '';
                
                Swal.fire({
                    title: 'แกก้ไขข้อมูล',
                    html: `
                        <form id="editForm">
                            <div class="row">
                                <!-- ฝ่ายแดง -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="edit_person_red" class="font-weight-bold text-danger">
                                            ฝ่ายแดง
                                        </label>
                                        <input type="text" 
                                            class="form-control" 
                                            id="edit_person_red" 
                                            value="${person_red}" 
                                            required
                                            placeholder="ชื่อนักมวยฝ่ายแดง">
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="edit_image_red" class="font-weight-bold text-danger">รูปฝ่ายแดง</label>
                                        ${image_red ? `
                                            <div class="mb-2">
                                                <img src="${image_red}" class="img-thumbnail" width="150">
                                            </div>
                                        ` : '<p class="text-muted">ไม่มีรูปภาพ</p>'}
                                        <input type="file" 
                                            class="form-control" 
                                            id="edit_image_red"
                                            accept="image/*">
                                    </div>
                                </div>

                                <!-- ฝ่ายน้ำเงิน -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="edit_person_blue" class="font-weight-bold text-primary">
                                            ฝ่ายน้ำเงิน
                                        </label>
                                        <input type="text" 
                                            class="form-control" 
                                            id="edit_person_blue" 
                                            value="${person_blue}" 
                                            required
                                            placeholder="ชื่อนักมวยฝ่ายน้ำเงิน">
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="edit_image_blue class="font-weight-bold text-primary">รูปฝ่ายน้ำเงิน</label>
                                        ${image_blue ? `
                                            <div class="mb-2">
                                                <img src="${image_blue}" class="img-thumbnail" width="150">
                                            </div>
                                        ` : '<p class="text-muted">ไม่มีรูปภาพ</p>'}
                                        <input type="file" 
                                            class="form-control" 
                                            id="edit_image_blue"
                                            accept="image/*">
                                    </div>
                                </div>
                            </div>
                        </form>
                    `,
                    width: '800px', // เพิ่มความกว้างของ modal
                    showCancelButton: true,
                    confirmButtonText: 'บันทึก',
                    cancelButtonText: 'ยกเลิก',
                    showLoaderOnConfirm: true,
                    preConfirm: () => {
                        // ตรวจสอบการกรอกข้อมูล
                        const person_red = $('#edit_person_red').val();
                        const person_blue = $('#edit_person_blue').val();

                        if (!person_red || !person_blue) {
                            Swal.showValidationMessage('กรุณากรอกชื่อให้ครบทั้งสองฝ่าย');
                            return false;
                        }

                        const formData = new FormData();
                        formData.append('id', id);
                        formData.append('person_red', person_red);
                        formData.append('person_blue', person_blue);
                        
                        const imageRed = $('#edit_image_red')[0].files[0];
                        const imageBlue = $('#edit_image_blue')[0].files[0];
                        
                        if (imageRed) formData.append('image_red', imageRed);
                        if (imageBlue) formData.append('image_blue', imageBlue);

                        return $.ajax({
                            url: '../../service/match/update_match.php',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false
                        }).then(response => {
                            try {
                                return JSON.parse(response);
                            } catch (error) {
                                throw new Error('เกิดข้อผิดพลาดในการประมวลผลขอมูล');
                            }
                        });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (result.value.status === 'success') {
                            Swal.fire({
                                icon: 'success',
                                title: 'สำเร็จ',
                                text: 'อัพเดทข้อมูลเรียบร้อยแล้ว'
                            }).then(() => {
                                // รีเฟรชตาราง
                                $('#matchDataTable').DataTable().ajax.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: result.value.message || 'ไม่สามารถอัพเดทข้อมูลได้'
                            });
                        }
                    }
                });
            });

            // Handle Delete Button Click
            $('#matchDataTable').on('click', '.delete-btn', function() {
                var id = $(this).data('id');
                Swal.fire({
                    title: 'ยืนยันการลบ',
                    text: "คุณต้องการลบข้อมูลนี้ใช่หรือไม่?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ใช่, ลบข้อมูล',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // เพิ่มโค้ดสำหรับการลบข้อมูล
                        $.ajax({
                            url: '../../service/match/delete_match.php',
                            type: 'POST',
                            data: { id: id },
                            success: function(response) {
                                try {
                                    const result = JSON.parse(response);
                                    if (result.status === 'success') {
                                        Swal.fire(
                                            'ลบสำเร็จ!',
                                            'ข้อมูลถูกลบเรียบร้อยแล้ว',
                                            'success'
                                        );
                                        table.ajax.reload();
                                    } else {
                                        throw new Error(result.message);
                                    }
                                } catch (e) {
                                    Swal.fire(
                                        'เกิดข้อผิดพลาด!',
                                        e.message,
                                        'error'
                                    );
                                }
                            }
                        });
                    }
                });
            });

            // จัดการปุ่มบันทึกและแก้ไขชื่อแมตช์
            $('#lockMatchNameButton').prop('disabled', false);
            $('#editMatchNameButton').prop('disabled', true);

            // เมื่อกดปุ่มบันทึกชื่อแมตช์
            $('#lockMatchNameButton').click(function() {
                const matchName = $('#data_match').val();
                if (!matchName) {
                    Swal.fire({
                        icon: 'error',
                        title: 'กรุณากรอกชื่อแมตช์',
                        text: 'โปรดกรอกชื่อแมตช์ก่อนบันทึก',
                        confirmButtonText: 'ตกลง'
                    });
                    return;
                }

                // ล็อคการแก้ไข
                $('#data_match').prop('readonly', true);
                // เปลี่ยนสีพื้นหลังให้เห็นว่าถูกล็อค
                $('#data_match').css('background-color', '#e9ecef');
                // ซลับสถะปุ่ม
                $('#lockMatchNameButton').prop('disabled', true);
                $('#editMatchNameButton').prop('disabled', false);
            });

            // เมื่อกดปุ่มแก้ไขชื่อแมตช์
            $('#editMatchNameButton').click(function() {
                // ปลดล็อคการแก้ไข
                $('#data_match').prop('readonly', false);
                // เปลี่ยนสีพื้นหลังกลับเป็นปกติ
                $('#data_match').css('background-color', '#fff');
                // ซ๪ลับสถะปุ่ม
                $('#editMatchNameButton').prop('disabled', true);
                $('#lockMatchNameButton').prop('disabled', false);
                // โฟัสที่ช่องกรอกข้อมูล
                $('#data_match').focus();
            });

            // เพิ่ม event handler สำหรับ toggle switch
            $('#matchDataTable').on('change', '.status-toggle', function() {
                const toggleElement = $(this);
                const id = toggleElement.data('id');
                // ใช้ checked property แทนการอ่านจาก data attribute
                const newStatus = toggleElement.prop('checked') ? 1 : 0;
                
                // Disable toggle while processing
                toggleElement.prop('disabled', true);
                
                console.log('Updating status:', { id, newStatus }); // Debug log
                
                $.ajax({
                    url: '../../service/match/update_status.php',
                    type: 'POST',
                    data: {
                        id: id,
                        isActive: newStatus
                    },
                    dataType: 'json'
                })
                .done(function(response) {
                    console.log('Server response:', response); // Debug log
                    if (response.status === 'success') {
                        // อัพเดท data-current-status
                        toggleElement.data('current-status', newStatus);
                        toastr.success(response.message);
                    } else {
                        // ถ้าไม่สำเร็จให้กลับไปค่าเดิม
                        toggleElement.prop('checked', !toggleElement.prop('checked'));
                        toastr.error(response.message);
                    }
                })
                .fail(function(jqXHR) {
                    console.error('Server Error:', jqXHR.responseText);
                    // กลับไปค่าเดิมเมื่อเกิดข้อผิดพลาด
                    toggleElement.prop('checked', !toggleElement.prop('checked'));
                    toastr.error('เกิดข้อผิดพลาดในการอัพเดทสถานะ');
                })
                .always(function() {
                    toggleElement.prop('disabled', false);
                });
            });
        });

        // Refresh table after adding new data
        function refreshTable() {
            $('#matchDataTable').DataTable().ajax.reload();
        }
    </script>



</body>

</html>