<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon.ico">
    <!-- stylesheet -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Kanit">
    <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="../../plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
    <link rel="stylesheet" href="../../assets/css/adminlte.min.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- Datatables -->
    <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <style>
        /* ปรับพื้นหลังและระยะห่างให้ตรงกับยกที่ 1-5 */
        .round-card {
            background: linear-gradient(to right, red 50%, blue 50%);
            border-radius: 10px;
            margin-bottom: 20px;
            /* ระยะห่างระหว่างรอบ */
            padding: 15px;
            /* เพิ่มการ padding เพื่อให้พื้นที่ดูสมดุล */
        }

        .round {
            background-color: transparent;
        }

        .card-body {
            padding-top: 1;
            /* ลบ padding บน */
        }

        .col-md-4 {
            margin-bottom: 20px;
            /* เพิ่มระยะห่างระหว่างคอลัมน์ */
        }

        /* เพิ่มการกำหนดความสูงของแต่ละรอบ */
        .round-card .round {
            height: 100%;
        }

        /* ปรับขนาดของปุ่มให้เหมาะสม */
        .btn-save {
            width: 120px;
        }

        /* ส่วนของ card-header ห้ามแก้ ลบ เพิ่ม */

        #matchContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            margin: 0;
            width: 100%;
            font-size: 2.5vw;
            /* ปรับขนาดฟอนต์ตามขนาดหน้าจอ */
        }

        .match-item span {
            font-size: 4rem;
            font-weight: 900;
        }

        .text-vs {
            margin: 0 10px 0 10px;
            font-size: 5rem;
            font-weight: 900;
            background: linear-gradient(to right, red 50%, blue 50%);
            background-clip: text;
            color: transparent;
        }
    </style>
</head>

<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <div id="sidebar"></div>
        <div class="content-wrapper pt-3">
            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow">
                                <div class="card-header shadow">
                                    <div class="d-flex justify-content-center align-items-center">
                                        <div class="dropdown">
                                            <h2>กรอกข้อมูล Manual</h2>
                                            <button class="btn btn-danger dropdown-toggle" type="button"
                                                id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true"
                                                aria-expanded="false">
                                                เลือกคู่มวย
                                            </button>
                                            <div class="dropdown-menu" id="matchDropdown" aria-labelledby="dropdownMenuButton">
                                                <!-- Match items will be populated here dynamically -->
                                            </div>
                                        </div>
                                        <!-- <input type="text" class="form-control mt-2" id="selectedMatch" readonly> -->
                                        <div class="flex-grow-1">
                                            <p class="text-center match-item" id="matchContainer">
                                                <!-- ส่วนแสดงชื่อนักมวย -->
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="card-body">

                                    <div class="row">
                                        <!-- ยกที่ 1 -->
                                        <div class="col-md-4">
                                            <div class="round-card p-3">
                                                <h1 class="round text-center text-white">ยกที่ 1</h1>
                                                <div class="row">
                                                    <div class="red-side col-6">
                                                        <label class="text-white" for="R1_JR1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R1_JR1" name="R1_JR1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R1_JR2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R1_JR2" name="R1_JR2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R1_JR3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R1_JR3" name="R1_JR3" placeholder="กรอกคะแนน">
                                                    </div>
                                                    <div class="blue-side col-6">
                                                        <label class="text-white" for="R1_JB1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R1_JB1" name="R1_JB1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R1_JB2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R1_JB2" name="R1_JB2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R1_JB3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R1_JB3" name="R1_JB3" placeholder="กรอกคะแนน">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-center mt-3">
                                                    <button class="btn btn-warning btn-save">บันทึก</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ยกที่ 2 -->
                                        <div class="col-md-4">
                                            <div class="round-card p-3">
                                                <h1 class="round text-center text-white">ยกที่ 2</h1>
                                                <div class="row">
                                                    <div class="red-side col-6">
                                                        <label class="text-white" for="R2_JR1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R2_JR1" name="R2_JR1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R2_JR2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R2_JR2" name="R2_JR2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R2_JR3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R2_JR3" name="R2_JR3" placeholder="กรอกคะแนน">
                                                    </div>
                                                    <div class="blue-side col-6">
                                                        <label class="text-white" for="R2_JB1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R2_JB1" name="R2_JB1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R2_JB2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R2_JB2" name="R2_JB2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R2_JB3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R2_JB3" name="R2_JB3" placeholder="กรอกคะแนน">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-center mt-3">
                                                    <button class="btn btn-warning btn-save">บันทึก</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ยกที่ 3 -->
                                        <div class="col-md-4">
                                            <div class="round-card p-3">
                                                <h1 class="round text-center text-white">ยกที่ 3</h1>
                                                <div class="row">
                                                    <div class="red-side col-6">
                                                        <label class="text-white" for="R3_JR1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R3_JR1" name="R3_JR1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R3_JR2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R3_JR2" name="R3_JR2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R3_JR3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R3_JR3" name="R3_JR3" placeholder="กรอกคะแนน">
                                                    </div>
                                                    <div class="blue-side col-6">
                                                        <label class="text-white" for="R3_JB1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R3_JB1" name="R3_JB1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R3_JB2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R3_JB2" name="R3_JB2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R3_JB3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R3_JB3" name="R3_JB3" placeholder="กรอกคะแนน">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-center mt-3">
                                                    <button class="btn btn-warning btn-save">บันทึก</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <!-- ยกที่ 4 -->
                                        <div class="col-md-4">
                                            <div class="round-card p-3">
                                                <h1 class="round text-center text-white">ยกที่ 4</h1>
                                                <div class="row">
                                                    <div class="red-side col-6">
                                                        <label class="text-white" for="R4_JR1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R4_JR1" name="R4_JR1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R4_JR2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R4_JR2" name="R4_JR2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R4_JR3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R4_JR3" name="R4_JR3" placeholder="กรอกคะแนน">
                                                    </div>
                                                    <div class="blue-side col-6">
                                                        <label class="text-white" for="R4_JB1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R4_JB1" name="R4_JB1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R4_JB2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R4_JB2" name="R4_JB2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R4_JB3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R4_JB3" name="R4_JB3" placeholder="กรอกคะแนน">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-center mt-3">
                                                    <button class="btn btn-warning btn-save">บันทึก</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ยกที่ 5 -->
                                        <div class="col-md-4">
                                            <div class="round-card p-3">
                                                <h1 class="round text-center text-white">ยกที่ 5</h1>
                                                <div class="row">
                                                    <div class="red-side col-6">
                                                        <label class="text-white" for="R5_JR1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R5_JR1" name="R5_JR1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R5_JR2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R5_JR2" name="R5_JR2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R5_JR3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R5_JR3" name="R5_JR3" placeholder="กรอกคะแนน">
                                                    </div>
                                                    <div class="blue-side col-6">
                                                        <label class="text-white" for="R5_JB1">JUDGE 1</label>
                                                        <input type="number" class="form-control mb-2" id="R5_JB1" name="R5_JB1" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R5_JB2">JUDGE 2</label>
                                                        <input type="number" class="form-control mb-2" id="R5_JB2" name="R5_JB2" placeholder="กรอกคะแนน">
                                                        <label class="text-white" for="R5_JB3">JUDGE 3</label>
                                                        <input type="number" class="form-control mb-2" id="R5_JB3" name="R5_JB3" placeholder="กรอกคะแนน">
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-center mt-3">
                                                    <button class="btn btn-warning btn-save">บันทึก</button>
                                                </div>
                                            </div>
                                        </div>

                                        
                                        <!-- สรุปคะแนน -->
                                        <div class="col-md-4">
                                            <div class="round-card p-3">
                                                <h1 class="round text-center text-white" style="font-size: 2.7rem;">
                                                    สรุคคะแนน</h1>
                                                <div class="row">
                                                    <div class="red-side col-6">
                                                        <label class="text-white" for="Score_JR1">SUM JUDGE 1</label>
                                                        <input type="number" class="form-control mb-4" id="Score_JR1" name="Score_JR1"
                                                            placeholder="สรุปคะแนน" disabled>
                                                        <label class="text-white" for="Score_JR2">SUM JUDGE 2</label>
                                                        <input type="number" class="form-control mb-4" id="Score_JR2" name="Score_JR2"
                                                            placeholder="สรุปคะแนน" disabled>
                                                        <label class="text-white" for="Score_JR3">SUM JUDGE 3</label>
                                                        <input type="number" class="form-control mb-4" id="Score_JR3" name="Score_JR3"
                                                            placeholder="สรุปคะแนน" disabled>
                                                    </div>
                                                    <div class="blue-side col-6">
                                                        <label class="text-white" for="Score_JB1">SUM JUDGE 1</label>
                                                        <input type="number" class="form-control mb-4" id="Score_JB1" name="Score_JB1"
                                                            placeholder="สรุปคะแนน" disabled>
                                                        <label class="text-white" for="Score_JB2">SUM JUDGE 2</label>
                                                        <input type="number" class="form-control mb-4" id="Score_JB2" name="Score_JB2"
                                                            placeholder="สรุปคะแนน" disabled>
                                                        <label class="text-white" for="Score_JB3">SUM JUDGE 3</label>
                                                        <input type="number" class="form-control mb-4" id="Score_JB3" name="Score_JB3"
                                                            placeholder="สรุปคะแนน" disabled>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div id="footer"></div>
    </div>

    <!-- scripts -->
    <script src="../../plugins/fontawesome-free/js/all.min.js"></script>
    <script src="../../plugins/jquery/jquery.min.js"></script>
    <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../../plugins/sweetalert2/sweetalert2.min.js"></script>
    <script src="../../assets/js/adminlte.min.js"></script>
    <!-- <script src="../../assets/js/index.js"></script> -->

    <script>
        // Load Sidebar
        fetch('../includes/sidebar.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('sidebar').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading sidebar:', error);
            });

        // Load Footer
        fetch('../includes/footer.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                document.getElementById('footer').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading footer:', error);
            });
    </script>

    <script>
        // ประกาศตัวแปร global
        let selectedMatchId = null;

        // Function to load matches
        function loadMatches() {
            fetch('../../service/matches.php')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    console.log('Raw response:', text);
                    try {
                        const data = JSON.parse(text);
                        const dropdownMenu = document.getElementById('matchDropdown');
                        dropdownMenu.innerHTML = '';

                        if (!Array.isArray(data) || data.length === 0) {
                            dropdownMenu.innerHTML = '<a class="dropdown-item">ไม่พบข้อมูลคู่มวย</a>';
                            return;
                        }

                        data.forEach(match => {
                            if (match && match.sport_person_id && match.person_red && match.person_blue) {
                                const item = document.createElement('a');
                                item.className = 'dropdown-item';
                                item.href = '#';
                                item.textContent = `${match.person_red} VS ${match.person_blue}`;
                                item.onclick = (e) => {
                                    e.preventDefault();
                                    selectBoxingMatch(match);
                                };
                                dropdownMenu.appendChild(item);
                            }
                        });
                    } catch (e) {
                        console.error('JSON parse error:', e, 'Response:', text);
                        throw new Error('Invalid JSON response from server');
                    }
                })
                .catch(error => {
                    console.error('Error loading matches:', error);
                    const dropdownMenu = document.getElementById('matchDropdown');
                    dropdownMenu.innerHTML = '<a class="dropdown-item text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</a>';
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'ไม่สามารถโหลดข้อมูลได้',
                        text: 'กรุณาลองใหม่อีกครั้ง'
                    });
                });
        }

        // Function to select boxing match
        function selectBoxingMatch(match) {
            console.log('Selected match:', match); // Debug log

            if (!match || !match.sport_person_id || !match.person_red || !match.person_blue) {
                console.error('Invalid match data:', match);
                Swal.fire({
                    icon: 'error',
                    title: 'ข้อมิดพลาด',
                    text: 'ข้อมูลการแข่งขันไม่ถูกต้อง'
                });
                return;
            }

            // อัพเดทการแสดงผลในปุ่ม dropdown ให้แสดงชื่อนักมวยทั้งคู่
            document.getElementById('dropdownMenuButton').textContent = `${match.person_red} VS ${match.person_blue}`;
            
            const matchContainer = document.getElementById('matchContainer');
            matchContainer.innerHTML = `
                <span class="text-danger">${match.person_red}</span>
                <span class="text-vs">VS</span>
                <span class="text-primary">${match.person_blue}</span>
            `;

            // เก็บค่า sport_person_id
            selectedMatchId = match.sport_person_id;

            // เคลียร์และโหลดคะแนน
            clearAllScores();
            loadExistingScores(selectedMatchId);
        }

        // Function to clear all scores
        function clearAllScores() {
            // ยกที่ 1-5
            for (let round = 1; round <= 5; round++) {
                // ฝั่งแดง
                document.getElementById(`R${round}_JR1`).value = '';
                document.getElementById(`R${round}_JR2`).value = '';
                document.getElementById(`R${round}_JR3`).value = '';
                
                // ฝั่งน้ำเงิน
                document.getElementById(`R${round}_JB1`).value = '';
                document.getElementById(`R${round}_JB2`).value = '';
                document.getElementById(`R${round}_JB3`).value = '';
            }

            // เคลียร์คะแนนรวม
            for (let judge = 1; judge <= 3; judge++) {
                document.getElementById(`Score_JR${judge}`).value = '';
                document.getElementById(`Score_JB${judge}`).value = '';
            }
        }

        // Function to load existing scores
        function loadExistingScores(sport_person_id) {
            if (!sport_person_id) {
                console.error('No sport_person_id provided');
                return;
            }

            console.log('Loading scores for:', sport_person_id);

            fetch('../../service/get_scores.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `sport_person_id=${encodeURIComponent(sport_person_id)}`
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received score data:', data);

                if (data.status === 'error') {
                    throw new Error(data.message);
                }

                if (!data || !data.scores) {
                    console.log('No existing scores found');
                    clearAllScores();
                    return;
                }

                const scores = data.scores;
                
                // ยกที่ 1-5
                for (let round = 1; round <= 5; round++) {
                    // ฝั่งแดง
                    document.getElementById(`R${round}_JR1`).value = scores[`R${round}_JR1`] !== null ? scores[`R${round}_JR1`] : '';
                    document.getElementById(`R${round}_JR2`).value = scores[`R${round}_JR2`] !== null ? scores[`R${round}_JR2`] : '';
                    document.getElementById(`R${round}_JR3`).value = scores[`R${round}_JR3`] !== null ? scores[`R${round}_JR3`] : '';
                    
                    // ฝั่งน้ำเงิน
                    document.getElementById(`R${round}_JB1`).value = scores[`R${round}_JB1`] !== null ? scores[`R${round}_JB1`] : '';
                    document.getElementById(`R${round}_JB2`).value = scores[`R${round}_JB2`] !== null ? scores[`R${round}_JB2`] : '';
                    document.getElementById(`R${round}_JB3`).value = scores[`R${round}_JB3`] !== null ? scores[`R${round}_JB3`] : '';
                }

                // คำนวณคะแนนรวม
                calculateTotalScores();
            })
            .catch(error => {
                console.error('Error loading scores:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถโหลดคะแนนได้',
                    text: 'กรุณาลองใหม่อีกครั้ง'
                });
            });
        }

        // Function to fill score form
        function fillScoreForm(scores) {
            for (let round = 1; round <= 5; round++) {
                for (let judge = 1; judge <= 3; judge++) {
                    const redInput = document.getElementById(`R${round}_JR${judge}`);
                    const blueInput = document.getElementById(`R${round}_JB${judge}`);
                    if (redInput && scores[`R${round}_JR${judge}`]) {
                        redInput.value = scores[`R${round}_JR${judge}`];
                    }
                    if (blueInput && scores[`R${round}_JB${judge}`]) {
                        blueInput.value = scores[`R${round}_JB${judge}`];
                    }
                }
            }
            // Calculate totals after filling scores
            calculateTotalScores();
        }

        // Add new function to calculate total scores
        function calculateTotalScores() {
            if (!selectedMatchId) {
                console.warn('No match selected');
                return;
            }

            // Debug log
            console.log('Calculating scores for match ID:', selectedMatchId);

            // สร้าง FormData object
            const formData = new FormData();
            formData.append('sport_person_id', selectedMatchId);

            // คำนวณคะแนนรวมสำหรับแต่ละกรรมการ
            for (let judge = 1; judge <= 3; judge++) {
                let redTotal = 0;
                let blueTotal = 0;
                
                // รวมคะแนนจากทุกยก
                for (let round = 1; round <= 5; round++) {
                    const redScore = parseFloat(document.getElementById(`R${round}_JR${judge}`).value) || 0;    
                    const blueScore = parseFloat(document.getElementById(`R${round}_JB${judge}`).value) || 0;
                    redTotal += redScore;
                    blueTotal += blueScore;
                }
                
                // เพิ่มคะแนนลงใน FormData
                formData.append(`Score_JR${judge}`, redTotal);
                formData.append(`Score_JB${judge}`, blueTotal);
                
                // อัพเดท UI
                document.getElementById(`Score_JR${judge}`).value = redTotal;
                document.getElementById(`Score_JB${judge}`).value = blueTotal;

                // Debug log
                console.log(`Judge ${judge} Totals:`, { red: redTotal, blue: blueTotal });
            }

            // ส่งข้อมูลไปยัง server
            fetch('../../service/save_total_scores.php', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                const text = await response.text(); // อ่าน response เป็น text ก่อน
                console.log('Raw response:', text); // Debug log

                try {
                    const data = JSON.parse(text); // แปลงเป็น JSON
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }
                    return data;
                } catch (e) {
                    throw new Error(`Parse error: ${e.message}\nRaw response: ${text}`);
                }
            })
            .then(data => {
                if (data.status === 'success') {
                    console.log('Total scores saved successfully');
                } else {
                    throw new Error(data.message || 'Failed to save total scores');
                }
            })
            .catch(error => {
                console.error('Error saving total scores:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกคะแนนรวมได้ กรุณาลองใหม่อีกครั้ง'
                });
            });
        }

        // Event listener for save buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Load matches when page loads
            loadMatches();

            // Add click handlers for save buttons
            document.querySelectorAll('.btn-save').forEach(button => {
                button.addEventListener('click', async function() {
                    if (!selectedMatchId) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'กรุณาเลือกคู่มวย',
                            text: 'โปรดเลือกคู่มวยก่อนบันทึกคะแนน'
                        });
                        return;
                    }

                    // Debug log
                    console.log('Current selectedMatchId:', selectedMatchId);

                    const roundCard = this.closest('.round-card');
                    const roundText = roundCard.querySelector('h1.round').textContent;
                    const round = parseInt(roundText.replace(/\D/g, ''));

                    if (isNaN(round)) {
                        console.error('Invalid round number');
                        return;
                    }

                    try {
                        const redScores = Array.from(roundCard.querySelectorAll('.red-side input')).map(input => input.value);
                        const blueScores = Array.from(roundCard.querySelectorAll('.blue-side input')).map(input => input.value);

                        // Debug log before saving
                        console.log('Attempting to save scores:', {
                            matchId: selectedMatchId,
                            round: round,
                            redScores: redScores,
                            blueScores: blueScores
                        });

                        await saveRoundScores(selectedMatchId, round, redScores, blueScores);

                        calculateTotalScores();

                        Swal.fire({
                            icon: 'success',
                            title: 'บันทึกสำเร็จ',
                            text: `บันทึกคะแนนยกที่ ${round} เรียบร้อยแล้ว`
                        });

                    } catch (error) {
                        console.error('Save error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถบันทึกคะแนนได้ กรุณาลองใหม่อีกครั้ง'
                        });
                    }
                });
            });

            // Add input event listeners to all score inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                if (input.id.startsWith('R') && !input.id.startsWith('Score')) {
                    input.addEventListener('input', calculateTotalScores);
                }
            });
        });

        // Function to save scores for a specific round
        async function saveRoundScores(matchId, round, redScores, blueScores) {
            try {
                // Debug log ก่อนส่งข้อมูล
                console.log('Saving scores for:', {
                    sport_person_id: matchId,
                    round: round,
                    redScores: redScores,
                    blueScores: blueScores
                });

                const formData = new FormData();
                formData.append('sport_person_id', matchId);
                formData.append('round', round);
                
                // Add red corner scores
                formData.append('red_judge1', redScores[0]);
                formData.append('red_judge2', redScores[1]);
                formData.append('red_judge3', redScores[2]);
                
                // Add blue corner scores
                formData.append('blue_judge1', blueScores[0]);
                formData.append('blue_judge2', blueScores[1]);
                formData.append('blue_judge3', blueScores[2]);

                const response = await fetch('../../service/save_score.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                // Debug log หลังได้รับผลลัพธ์
                console.log('Save result:', result);
                
                if (result.error) {
                    throw new Error(result.message);
                }

                return result;
            } catch (error) {
                console.error('Error saving scores:', error);
                throw error;
            }
        }

        function saveScores(round) {
            if (!selectedMatchId) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกคู่มวย',
                    text: 'โปรดเลือกคู่มวยก่อนบันทึกคะแนน'
                });
                return;
            }

            // เก็บค่าคะแนนจากฟอร์ม
            const scores = {
                sport_person_id: selectedMatchId,
                round: round,
                red_judge1: document.getElementById(`R${round}_JR1`).value || 0,
                red_judge2: document.getElementById(`R${round}_JR2`).value || 0,
                red_judge3: document.getElementById(`R${round}_JR3`).value || 0,
                blue_judge1: document.getElementById(`R${round}_JB1`).value || 0,
                blue_judge2: document.getElementById(`R${round}_JB2`).value || 0,
                blue_judge3: document.getElementById(`R${round}_JB3`).value || 0
            };

            // แปลงข้อมูลเป็น URL-encoded string
            const formData = new URLSearchParams();
            for (const [key, value] of Object.entries(scores)) {
                formData.append(key, value);
            }

            // ส่งข้อมูลไปยัง server
            fetch('../../service/save_score.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกสำเร็จ',
                        text: 'บันทึกคะแนนเรียบร้อยแล้ว'
                    });
                } else {
                    throw new Error(data.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }
            })
            .catch(error => {
                console.error('Error saving scores:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message || 'ไม่สามารถบันทึกคะแนนได้ กรุณาลองใหม่อีกครั้ง'
                });
            });
        }
    </script>

</body>

</html>